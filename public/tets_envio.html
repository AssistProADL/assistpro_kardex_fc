<!doctype html>
<meta charset="utf-8">
<title>Tester de envío AssistPro RFID</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:8px;margin:6px 0}
  textarea{height:190px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .ok{color:#0a7f3f} .err{color:#b00020}
</style>

<h2>Tester de envío AssistPro RFID</h2>

<label>API base (termina en /):</label>
<input id="api" placeholder="http://localhost/inventarios_assistpro_rfid/public/api/" />

<div class="row">
  <div>
    <label>inv_id</label><input id="inv" value="65">
  </div>
  <div>
    <label>Usuario</label><input id="usr" value="Administrador General">
  </div>
</div>

<div class="row">
  <div>
    <label>Almacén (opcional)</label><input id="alm" value="">
  </div>
  <div>
    <label>Dispositivo</label><input id="dev" value="MC3xx">
  </div>
</div>

<label>EPCs (uno por línea)</label>
<textarea id="epcs">E200TEST0000000000000001
E200TEST0000000000000002</textarea>

<button id="go">Enviar</button>

<h3>Respuesta</h3>
<pre id="raw" style="white-space:pre-wrap;background:#f6f8fa;padding:10px;border:1px solid #ddd"></pre>
<div id="parsed"></div>

<script>
  const $=s=>document.querySelector(s);
  $("#go").onclick=async()=>{
    const base=$("#api").value.trim();
    if(!base||!/\/$/.test(base)){ alert('La API debe terminar con "/"'); return; }

    const body={
      inv_id: parseInt($("#inv").value,10),
      usuario: $("#usr").value.trim(),
      almacen: $("#alm").value.trim() || null,
      device: $("#dev").value.trim() || 'MC3xx',
      lecturas: $("#epcs").value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)
    };

    const r = await fetch(base+"lecturas_upsert.php",{
      method:"POST",headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const text=await r.text();
    $("#raw").textContent=text;

    try{
      const j=JSON.parse(text);
      $("#parsed").innerHTML = j.ok
        ? `<p class="ok">OK — insertados: <b>${j.inserted||0}</b>, actualizados: <b>${j.updated||0}</b>, foráneos: <b>${j.unmatched||0}</b></p>`
        : `<p class="err">ERROR — ${j.msg||'sin mensaje'} (code: ${j.code||'n/a'})</p>`;
    }catch(e){
      $("#parsed").innerHTML = `<p class="err">No se pudo parsear JSON</p>`;
    }
  };
</script>
